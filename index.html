<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranch Lab ‚Äì Home</title>

  <style>
    :root {
      --bg: #faf7ff;
      --ink: #1f2937;
      --ink2: #4b5563;
      --brand: #6d28d9;
      --card: #ffffff;
      --line: #e5e7eb;
      --success: #10b981;
      --warning: #f59e0b;
      --shadow: 0 10px 25px rgba(17, 24, 39, 0.07);
      --modal-purple: #f3e8ff; /* purple modal background */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Inter, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.6;
    }

    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      position: sticky; top: 0;
      backdrop-filter: saturate(140%) blur(6px);
      background: rgba(250, 247, 255, 0.85);
      border-bottom: 1px solid var(--line);
      z-index: 50;
    }
    .nav { max-width: 900px; margin: auto; display: flex; gap: 16px; align-items: center; justify-content: space-between; padding: 12px 16px; }

    main { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    section { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 24px; margin: 24px 0; box-shadow: 0 2px 10px rgba(0,0,0,.03); }

    h1 { font-size: 32px; margin: 0 0 8px; font-weight: 700; }
    h2 { font-size: 24px; margin: 0 0 16px; font-weight: 600; }
    h3 { font-size: 18px; margin: 0 0 8px; font-weight: 600; }
    p  { color: var(--ink2); margin: 8px 0; }

    /* How it works */
    .how-wrap { display: grid; grid-template-columns: 1fr; gap: 16px; align-items: center; }
    @media (min-width: 768px) { .how-wrap { grid-template-columns: 1fr auto 1fr auto 1fr; } }

    .how-card { background: linear-gradient(180deg, #ffffff 0%, #f3f4f6 100%); border: 1px solid var(--line); border-radius: 16px; padding: 24px; text-align: center; box-shadow: var(--shadow); }
    .how-num { width: 40px; height: 40px; border-radius: 999px; margin: 0 auto 12px; background: var(--brand); color: #fff; display: grid; place-items: center; font-weight: 800; box-shadow: 0 6px 18px rgba(109,40,217,.35); }
    .how-arrow { display: none; font-size: 22px; color: var(--brand); font-weight: 800; text-align: center; }
    @media (min-width: 768px) { .how-arrow { display: block; } }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }

    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; background: var(--card); }

    .menu-item { border: 1px solid var(--line); border-radius: 12px; padding: 16px; background: var(--card); transition: border-color .2s; }
    .menu-item:hover { border-color: var(--brand); }

    .muted { color: var(--ink2); }

    .btn { appearance: none; border: 0; background: var(--brand); color: #fff; padding: 12px 20px; border-radius: 16px; cursor: pointer; font-weight: 700; font-size: 18px; transition: background .2s; text-align: center; display: inline-block; }
    .btn:hover { background: #5b21b6; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    .btn-outline { background: #fff; color: var(--brand); border: 3px solid var(--brand); border-radius: 16px; padding: 12px 20px; font-weight: 700; font-size: 18px; }
    .btn-outline:hover { background: rgba(109,40,217,.06); }

    .cta { display: flex; gap: 24px; flex-wrap: wrap; margin-top: 12px; }

    .form-row { display: flex; flex-direction: column; gap: 6px; margin: 12px 0; }
    input[type=text],input[type=email],input[type=tel],input[type=number],select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--line); font-size: 14px; background: #fff; }
    input[type=number]{ max-width: 80px; }

    .price-display { font-weight: 600; color: var(--brand); font-size: 18px; margin: 8px 0; }
    .item-total { font-size: 14px; color: var(--ink2); margin-top: 8px; }

    .order-summary { background: #f8fafc; padding: 16px; border-radius: 8px; margin: 16px 0; min-height: 60px; }
    .totals { display: grid; grid-template-columns: 1fr auto; row-gap: 8px; column-gap: 20px; margin: 16px 0; }
    .totals div:last-child { text-align: right; }

    .fulfillment-options { display: flex; gap: 20px; margin: 24px 0; justify-content: center; flex-wrap: wrap; }
    .fulfillment-btn { flex: 1; min-width: 240px; max-width: 280px; padding: 24px 20px; background: var(--card); border: 2px solid var(--line); border-radius: 16px; cursor: pointer; transition: all .2s ease; text-align: center; }
    .fulfillment-btn:hover { border-color: var(--brand); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(109,40,217,.15); }
    .fulfillment-btn.selected { border-color: var(--brand); background: rgba(109,40,217,.05); box-shadow: 0 4px 20px rgba(109,40,217,.2); }
    .fulfillment-icon { font-size: 32px; margin-bottom: 12px; }

    .schedule-container { background: #f8fafc; border-radius: 12px; padding: 20px; margin: 16px 0; border: 1px solid var(--line); }
    .schedule-explanation { color: var(--ink2); margin: 0 0 16px; font-style: italic; text-align: center; }
    .date-time-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 768px) { .date-time-selector { grid-template-columns: 1fr; } }

    .order-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #e5e7eb; }
    .order-item:last-child { border-bottom: none; }
    .order-item-name { font-weight: 500; color: var(--ink); margin-bottom: 4px; }
    .order-item-qty { font-size: 14px; color: var(--ink2); }
    .order-item-price { font-weight: 500; color: var(--ink); }

    footer { max-width: 900px; margin: 28px auto; padding: 0 16px 40px; color: var(--ink2); text-align: center; }
    .hero { display: flex; flex-direction: column; gap: 12px; margin: 8px 0 8px; }

    /* Message Box */
    .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--warning); color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, .1); z-index: 100; transition: opacity .3s; opacity: 0; }
    .message-box.show { opacity: 1; }

    /* Modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(17,24,39,.5); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }
    .modal-backdrop.show { display: flex; }
    .modal-card { background: var(--modal-purple); border: 1px solid var(--line); border-radius: 16px; box-shadow: var(--shadow); width: 384px; height: 356px; overflow: hidden; padding: 0; position: relative; color: #1f2937; }
    @media (max-width: 800px) {
      .modal-card { width: 95vw; height: 80vh; }
    }

    .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .btn-small { font-size: 14px; padding: 10px 14px; border-radius: 12px; }
  </style>
</head>

<body>
  <!-- Header (brand + tabs removed per your request) -->
  <header>
    <nav class="nav" aria-label="primary"><!-- empty on purpose --></nav>
  </header>

  <main>
    <div id="message-box" class="message-box"></div>

    <!-- Intro -->
    <section id="intro">
      <div class="hero">
        <h1>Fire-inspired cooking crafted from my travels</h1>
        <div class="cta">
          <a class="btn" id="openStory" href="#">My Story</a>
          <a class="btn btn-outline" id="openCooking" href="#">My Cooking</a>
        </div>
      </div>
    </section>

    <!-- How It Works -->
    <section id="how">
      <h2>How It Works</h2>
      <div class="how-wrap">
        <div class="how-card">
          <div class="how-num">1</div>
          <h3>Choose Your Menu</h3>
          <p class="muted">Select from our seasonal offerings crafted with intention</p>
        </div>
        <div class="how-arrow">‚Üí</div>
        <div class="how-card">
          <div class="how-num">2</div>
          <h3>Select Pickup or Delivery</h3>
          <p class="muted">Pick up at our kitchen or arrange Uber delivery</p>
        </div>
        <div class="how-arrow">‚Üí</div>
        <div class="how-card">
          <div class="how-num">3</div>
          <h3>Order</h3>
          <p class="muted">Secure checkout with instant confirmation</p>
        </div>
      </div>
    </section>

    <!-- Menu -->
    <section id="menu">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
        <h2 style="margin: 0;">Fall Menu: Ember &amp; Sea</h2>
        <button class="btn btn-outline btn-small" id="openWinter" style="font-size: 14px; padding: 8px 16px;">Winter: Dolomites &amp; Piedmont</button>
        <button class="btn btn-outline btn-small" id="openSpring" style="font-size: 14px; padding: 8px 16px;">Spring: Japan</button>
        <button class="btn btn-outline btn-small" id="openSummer" style="font-size: 14px; padding: 8px 16px;">Summer: Baja</button>
      </div>
      <div class="grid">
        <div class="menu-item">
          <h3>Roasted Pepper Spread &amp; Grilled Bread</h3>
          <div class="muted">Fire-roasted red peppers with churned local cream, lightly smoked over oak. Served with house-made sourdough.</div>
          <div class="price-display">$12.00</div>
          <div class="form-row">
            <label>Quantity</label>
            <input type="number" min="0" value="0" step="1" data-price="12" data-name="Roasted Pepper Spread & Grilled Bread" class="qty" />
          </div>
          <div class="item-total">Total: $<span class="item-subtotal">0.00</span></div>
        </div>

        <div class="menu-item">
          <h3>Autumn Mushrooms</h3>
          <div class="muted">Chanterelles &amp; porcini seared over live coals with olive oil, herbs, and flaky salt.</div>
          <div class="price-display">$18.00</div>
          <div class="form-row">
            <label>Quantity</label>
            <input type="number" min="0" value="0" step="1" data-price="18" data-name="Autumn Mushrooms" class="qty" />
          </div>
          <div class="item-total">Total: $<span class="item-subtotal">0.00</span></div>
        </div>

        <div class="menu-item">
          <h3>Wood-Fired Ribeye</h3>
          <div class="muted">Prime ribeye over oak coals, finished with herb butter &amp; sea salt. Serves 2.</div>
          <div class="price-display">$45.00</div>
          <div class="form-row">
            <label>Quantity</label>
            <input type="number" min="0" value="0" step="1" data-price="45" data-name="Wood-Fired Ribeye" class="qty" />
          </div>
          <div class="item-total">Total: $<span class="item-subtotal">0.00</span></div>
        </div>

        <div class="menu-item">
          <h3>Charred Seasonal Vegetables</h3>
          <div class="muted">Market vegetables over live fire with olive oil, lemon, and herbs.</div>
          <div class="price-display">$16.00</div>
          <div class="form-row">
            <label>Quantity</label>
            <input type="number" min="0" value="0" step="1" data-price="16" data-name="Charred Seasonal Vegetables" class="qty" />
          </div>
          <div class="item-total">Total: $<span class="item-subtotal">0.00</span></div>
        </div>
      </div>
    </section>

    <!-- Order -->
    <section id="order">
      <h2>Select Pickup or Delivery</h2>

      <div class="fulfillment-options">
        <button class="fulfillment-btn" id="pickupBtn" onclick="selectChoice('pickup')">
          <div class="fulfillment-icon">üìç</div>
          <h3>Pick Up</h3>
          <p>Select your pickup date &amp; time</p>
        </button>
        <button class="fulfillment-btn" id="deliveryBtn" onclick="selectChoice('delivery')">
          <div class="fulfillment-icon">üöö</div>
          <h3>Delivery</h3>
          <p>Via Uber (you pay Uber separately)</p>
        </button>
      </div>

      <div id="pickupSchedule" style="display:none" class="schedule-container">
        <p class="schedule-explanation">Selecting a pickup time helps us have your order ready.</p>
        <div class="date-time-selector">
          <div class="form-row">
            <label>Select Date</label>
            <select id="pickupDate" onchange="updateTimes('pickup')">
              <option value="">Choose a date...</option>
              <option value="2025-10-04">October 4, 2025</option>
              <option value="2025-10-05">October 5, 2025</option>
              <option value="2025-11-01">November 1, 2025</option>
              <option value="2025-11-02">November 2, 2025</option>
              <option value="2025-12-06">December 6, 2025</option>
              <option value="2025-12-07">December 7, 2025</option>
            </select>
          </div>
          <div class="form-row">
            <label>Select Time Slot</label>
            <select id="pickupTime" disabled>
              <option value="">First select a date</option>
            </select>
          </div>
        </div>
      </div>

      <div id="deliverySchedule" style="display:none" class="schedule-container">
        <p class="schedule-explanation">Choose when your order should be ready for Uber pickup.</p>
        <div class="date-time-selector">
          <div class="form-row">
            <label>Select Date</label>
            <select id="deliveryDate" onchange="updateTimes('delivery')">
              <option value="">Choose a date...</option>
              <option value="2025-10-04">October 4, 2025</option>
              <option value="2025-10-05">October 5, 2025</option>
              <option value="2025-11-01">November 1, 2025</option>
              <option value="2025-11-02">November 2, 2025</option>
              <option value="2025-12-06">December 6, 2025</option>
              <option value="2025-12-07">December 7, 2025</option>
            </select>
          </div>
          <div class="form-row">
            <label>Select Time Slot</label>
            <select id="deliveryTime" disabled>
              <option value="">First select a date</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Payment / Summary -->
    <section id="payment">
      <h2>Order</h2>

      <div class="grid">
        <div class="card">
          <h3>Order Summary</h3>
          <div id="orderSummary" class="order-summary"><p class="muted">No items selected</p></div>
          <div class="totals">
            <div>Subtotal</div><div id="subtotal">$0.00</div>
            <div>CA Tax (10.25%)</div><div id="tax">$0.00</div>
            <div><strong>Total</strong></div><div id="total"><strong>$0.00</strong></div>
          </div>
        </div>

        <div class="card">
          <h3>Payment Details</h3>
          <div class="form-row">
            <label>Full Name *</label>
            <input id="customerName" type="text" placeholder="Your full name" required>
          </div>
          <div class="form-row">
            <label>Email *</label>
            <input id="customerEmail" type="email" placeholder="your@email.com" required>
          </div>
          <div class="form-row">
            <label>Phone Number *</label>
            <input id="customerPhone" type="tel" placeholder="(310) 666-0797" required>
          </div>
          <button id="submit-order" class="btn" style="width:100%; margin-top:16px;">Complete Order</button>
          <p class="note">Payment integration coming soon. You'll receive confirmation via email.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <hr style="border:0; border-top:1px solid var(--line); margin:20px 0;"/>
    <div class="note" style="margin-top:12px;">
      Questions? <a href="mailto:milos@ranchlab.is">milos@ranchlab.is</a> ¬∑ 
      <a href="tel:+13106660797">(310) 666-0797</a>
    </div>
  </footer>

  <!-- My Story Modal -->
  <div id="storyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="storyTitle" style="width: 20cm; height: 20cm; padding: 20px; overflow: auto;">
      <button class="modal-close" aria-label="Close" id="closeStory" style="position: absolute; top: 10px; right: 12px; border: 0; background: transparent; cursor: pointer; font-size: 22px; color: var(--ink);">&times;</button>
      <h2 id="storyTitle">My Story: From the Ocean to the Fire</h2>
      <p>I'm Milos, a longtime Bay Area resident, new Piedmont neighbor, first-time dad, and former sustainable fashion entrepreneur. Last August, I sold my third company: a zero-plastic apparel brand built on the principles of circularity. We created apparel and footwear designed to last a lifetime, yet capable of being composted back into soil that can grow anything green and alive.</p>
      <p>After years of building businesses, I've decided to follow a different path and one of my deepest personal passions: food and wellness. Cooking has always been a daily ritual in our home, especially since becoming a parent. Friends and family kept telling me, "You should offer this to others." So I am. And as with everything I've built, I'm doing it in a way that feels entirely my own.</p>
      <p>Spearfishing was my stepping stone to true freshness. That first yellowtail and yellowfin I caught, hours from ocean to plate, taught me that when ingredients are this pure, they need almost nothing more.</p>
      <p>The same is true for everything I cook with.  I want to know the story behind each ingredient: where it came from, how it was made, and who made it. Just as wine lovers trace a winemaker's path to each vintage, I search for those "winemakers" in every element of food. From hand-pressed olive oil to centuries-old fermentation techniques, the process matters as much as the outcome because the process is the alchemy. It's a living library, and every ingredient holds a chapter worth studying.</p>
      <p>To me, flavor is a fine balance between purity and complexity. When done right, flavor is also health. We evaluate growers, makers, and artisans through flavor. When the balance is just right, that evaluation turns into trust. That trust extends to our health, because when food is grown and made with integrity, health follows naturally.</p>
      <p>Flavor is our contract with the growers, makers, and artisans we work with. The better the flavor, the deeper the bond. My goal is to create the strongest bond possible.</p>
      <p>Fire is how I honor that contract. It demands patience and presence. Wood is nature's seasoning, each variety leaving its own signature. Mesquite is the full-bodied cabernet of woods. Fruit woods bring a gentle, fragrant sweetness. Together, they create new possibilities but also demand restraint and intuition to truly heighten each ingredient's essence.</p>
      <p>What I share isn't just a meal. It's the sum of relationships, craft, and a relentless pursuit of flavor, health, joy, creativity, and sustainability. This fall marks the first chapter: a menu inspired by the fire traditions of San Sebasti√°n and the visionary chef behind Asador Etxebarri, whose mastery has inspired chefs around the world to embrace the art of cooking over live fire.</p>
    </div>
  </div>

  <!-- Winter Modal -->
  <div id="winterModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="winterTitle" style="width: 500px; height: 300px; padding: 20px;">
      <button class="modal-close" aria-label="Close" id="closeWinter" style="position: absolute; top: 10px; right: 12px; border: 0; background: transparent; cursor: pointer; font-size: 22px; color: var(--ink);">&times;</button>
      <h2 id="winterTitle">Winter: Dolomites &amp; Piedmont</h2>
      <p>Skiing and hiking initially drove me to this region. A memory that's inspiring the winter, alpine menu is Italian-Austrian chef, Norbert Niederkofler's Cook the Mountain philosophy.</p>
      <p>Ingredients that I am thinking about are chestnuts, polenta, char, trout, truffles, wild boar, veal, fermented root veggies.</p>
    </div>
  </div>

  <!-- Spring Modal -->
  <div id="springModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="springTitle" style="width: 500px; height: 300px; padding: 20px;">
      <button class="modal-close" aria-label="Close" id="closeSpring" style="position: absolute; top: 10px; right: 12px; border: 0; background: transparent; cursor: pointer; font-size: 22px; color: var(--ink);">&times;</button>
      <h2 id="springTitle">Spring: Japan</h2>
      <p>I'd love to spend time living in Japan. My first true introduction came through my friend's Tokyo restaurant, Udatsu, which earned the fastest Michelin star in Japan, and through skiing the legendary powder of Hokkaido.</p>
      <p>For cherry blossom season, the menu will center on cherry wood smoke, yakitori, yellowtail, king crab, saba, and wagyu, miso and koji fermentation.</p>
    </div>
  </div>

  <!-- Summer Modal -->
  <div id="summerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="summerTitle" style="width: 500px; height: 300px; padding: 20px;">
      <button class="modal-close" aria-label="Close" id="closeSummer" style="position: absolute; top: 10px; right: 12px; border: 0; background: transparent; cursor: pointer; font-size: 22px; color: var(--ink);">&times;</button>
      <h2 id="summerTitle">Summer: Baja</h2>
      <p>My introduction to Baja began in Cerritos and Todos Santos. Baja is a waterman's dream. The menu will be inspired by my favorite fish, Kampachi (amberjack) and Anthony Bourdain's beloved Ensenada cevicher√≠a, La Guerrerense.</p>
      <p>Ceviche, pastor, short rib, nopales, agave and more.</p>
    </div>
  </div>

  <!-- My Cooking Modal (with Instagram feed) -->
  <div id="cookingModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="cookingTitle">
      <button class="modal-close" aria-label="Close" id="closeCooking" style="position: absolute; top: 10px; right: 12px; border: 0; background: rgba(255,255,255,0.9); cursor: pointer; font-size: 22px; color: var(--ink); z-index: 1001; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
      <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/myranchlab/" data-instgrm-version="14" style="background:#FFF; border:0; border-radius:16px; box-shadow:none; margin:0; width:100%; height:100%; min-height:100%; padding:0; position: absolute; top: 0; left: 0;">
        <div style="padding:16px;">
          <a href="https://www.instagram.com/myranchlab/" style="background:#FFFFFF; line-height:0; padding:0 0; text-align:center; text-decoration:none; width:100%;" target="_blank">
            <div style="display: flex; flex-direction: row; align-items: center;">
              <div style="background-color: #F4F4F4; border-radius: 50%; flex-grow: 0; height: 40px; margin-right: 14px; width: 40px;"></div>
              <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center;">
                <div style="background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; margin-bottom: 6px; width: 100px;"></div>
                <div style="background-color: #F4F4F4; border-radius: 4px; flex-grow: 0; height: 14px; width: 60px;"></div>
              </div>
            </div>
          </a>
        </div>
      </blockquote>
      <script async src="//www.instagram.com/embed.js"></script>
    </div>
  </div>

  <script>
    // Toast / message box
    function showMessage(message, type = 'warning') {
      const msgBox = document.getElementById('message-box');
      if (!msgBox) return;
      msgBox.textContent = message;
      msgBox.style.backgroundColor = type === 'success' ? 'var(--success)' : 'var(--warning)';
      msgBox.classList.add('show');
      setTimeout(() => { msgBox.classList.remove('show'); }, 3000);
    }

    // Cart + Summary + Checkout
    (function () {
      const TAX_RATE = 0.1025;

      function readCart() {
        return Array.from(document.querySelectorAll('.menu-item'))
          .map(card => {
            const input = card.querySelector('.qty');
            const name  = input?.dataset.name || '';
            const price = parseFloat(input?.dataset.price || '0');
            const qty   = parseInt(input?.value || '0', 10) || 0;
            return { name, price, qty };
          })
          .filter(i => i.qty > 0);
      }

      function renderSummary() {
        const cart = readCart();

        const summaryEl = document.getElementById('orderSummary');
        const subEl = document.getElementById('subtotal');
        const taxEl = document.getElementById('tax');
        const totalEl = document.getElementById('total');

        if (!summaryEl) return;

        if (cart.length === 0) {
          summaryEl.innerHTML = '<p class="muted">No items selected</p>';
        } else {
          summaryEl.innerHTML = cart.map(i => `
            <div class="order-item">
              <div class="order-item-details">
                <div class="order-item-name">${i.name}</div>
                <div class="order-item-qty">Qty: ${i.qty}</div>
              </div>
              <div class="order-item-price">${(i.price * i.qty).toFixed(2)}</div>
            </div>
          `).join('');
        }

        const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;

        if (subEl) subEl.textContent = `${subtotal.toFixed(2)}`;
        if (taxEl) taxEl.textContent = `${tax.toFixed(2)}`;
        if (totalEl) totalEl.innerHTML = `<strong>${total.toFixed(2)}</strong>`;
      }

      function onQtyChange(input) {
        const qty = parseInt(input.value || '0', 10) || 0;
        const price = parseFloat(input.dataset.price || '0') || 0;
        const itemSubtotalEl = input.closest('.menu-item')?.querySelector('.item-subtotal');
        if (itemSubtotalEl) itemSubtotalEl.textContent = (qty * price).toFixed(2);
        renderSummary();
        saveCart();
      }

      function saveCart() {
        const cart = readCart();
        try {
          localStorage.setItem('ranchlab_cart', JSON.stringify(cart));
        } catch (e) {
          // Ignore localStorage errors
        }
      }

      function restoreCart() {
        try {
          const saved = localStorage.getItem('ranchlab_cart');
          if (!saved) return;
          const cart = JSON.parse(saved);
          cart.forEach(i => {
            const input = document.querySelector(`.qty[data-name="${i.name}"]`);
            if (input) input.value = i.qty;
          });
        } catch (e) {
          // Ignore localStorage errors
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        restoreCart();
        document.querySelectorAll('.qty').forEach(input => {
          onQtyChange(input);
          input.addEventListener('input',  () => onQtyChange(input));
          input.addEventListener('change', () => onQtyChange(input));
        });
        renderSummary();
      });

      // Checkout
      async function createCheckoutSession(payload) {
        const res = await fetch('/api/checkout', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      document.getElementById('submit-order').addEventListener('click', async () => {
        const cartItems = Array.from(document.querySelectorAll('.menu-item')).map(card => {
          const input = card.querySelector('.qty');
          const name  = input?.dataset.name || '';
          const price = parseFloat(input?.dataset.price || '0');
          const quantity = parseInt(input?.value || '0', 10) || 0;
          return { name, price, quantity };
        }).filter(i => i.quantity > 0);

        if (!cartItems.length) { showMessage('Please add at least one item.'); return; }

        const customer = {
          name:  document.getElementById('customerName').value.trim(),
          email: document.getElementById('customerEmail').value.trim(),
          phone: document.getElementById('customerPhone').value.trim(),
        };
        if (!customer.name || !customer.email || !customer.phone) {
          showMessage('Please enter name, email, and phone.'); 
          return;
        }

        const orderType = document.getElementById('pickupSchedule').style.display === 'block' ? 'pickup' : 'delivery';
        const slot = orderType === 'pickup'
          ? `${document.getElementById('pickupDate').value} ${document.getElementById('pickupTime').value}`
          : `${document.getElementById('deliveryDate').value} ${document.getElementById('deliveryTime').value}`;

        try {
          const { url } = await createCheckoutSession({ cartItems, orderType, slot, customer });
          window.location = url;
        } catch (e) {
          showMessage('Checkout failed: ' + e.message);
        }
      });
    })();

    // Fulfillment toggles + times
    function selectChoice(type) {
      const pickupBtn = document.getElementById('pickupBtn');
      const deliveryBtn = document.getElementById('deliveryBtn');
      const pickupSchedule = document.getElementById('pickupSchedule');
      const deliverySchedule = document.getElementById('deliverySchedule');
      pickupBtn.classList.remove('selected');
      deliveryBtn.classList.remove('selected');
      pickupSchedule.style.display = 'none';
      deliverySchedule.style.display = 'none';
      if (type === 'pickup') {
        pickupBtn.classList.add('selected');
        pickupSchedule.style.display = 'block';
      } else {
        deliveryBtn.classList.add('selected');
        deliverySchedule.style.display = 'block';
      }
    }

    function updateTimes(type) {
      const dateEl = document.getElementById(type + 'Date');
      const timeEl = document.getElementById(type + 'Time');
      const reserveBtn = document.getElementById('reserveUber');
      
      if (dateEl.value) {
        timeEl.disabled = false;
        timeEl.innerHTML = '<option value="">Select time...</option>';
        // Generate 12:00pm‚Äì1:45pm in 15-min increments (last slot ends at 2:00pm)
        for (let hour = 12; hour < 14; hour++) {
          for (let min = 0; min < 60; min += 15) {
            const startHour = hour > 12 ? hour - 12 : hour;
            const startSuffix = hour >= 12 ? 'pm' : 'am';
            const endMin = min + 15;
            const endHour = endMin >= 60 ? hour + 1 : hour;
            const endSuffix = endHour >= 12 ? 'pm' : 'am';
            const endDisplayHour = endHour > 12 ? endHour - 12 : endHour;
            const start = `${startHour}:${(min < 10 ? '0' : '')}${min}${startSuffix}`;
            const end = `${endDisplayHour}:${((endMin % 60) < 10 ? '0' : '')}${(endMin % 60)}${endSuffix}`;
            const option = document.createElement('option');
            option.value = start;
            option.textContent = start + ' - ' + end;
            timeEl.appendChild(option);
          }
        }
        
        // Add event listener to show Reserve Uber button when time is selected
        if (type === 'delivery') {
          timeEl.addEventListener('change', function() {
            if (this.value && reserveBtn) {
              reserveBtn.style.display = 'block';
            }
          });
        }
      } else {
        timeEl.disabled = true;
        timeEl.innerHTML = '<option value="">First select a date</option>';
        if (reserveBtn && type === 'delivery') {
          reserveBtn.style.display = 'none';
        }
      }
    }

    // Reserve Uber functionality
    document.addEventListener('DOMContentLoaded', () => {
      const reserveBtn = document.getElementById('reserveUber');
      if (reserveBtn) {
        reserveBtn.addEventListener('click', () => {
          const date = document.getElementById('deliveryDate').value;
          const time = document.getElementById('deliveryTime').value;
          if (date && time) {
            showMessage('Uber reservation feature coming soon! Please complete your order first.', 'warning');
          }
        });
      }
    });

    // Modals (Story + Cooking + Winter + Spring + Summer)
    (function () {
      // Story modal
      const storyOpen = document.getElementById('openStory');
      const storyModal = document.getElementById('storyModal');
      const storyClose = document.getElementById('closeStory');

      function openStory(e) {
        e?.preventDefault();
        storyModal.classList.add('show');
        storyModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      function closeStory() {
        storyModal.classList.remove('show');
        storyModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      if (storyOpen) storyOpen.addEventListener('click', openStory);
      if (storyClose) storyClose.addEventListener('click', closeStory);
      if (storyModal) storyModal.addEventListener('click', (e) => { if (e.target === storyModal) closeStory(); });

      // Winter modal
      const winterOpen = document.getElementById('openWinter');
      const winterModal = document.getElementById('winterModal');
      const winterClose = document.getElementById('closeWinter');

      function openWinter(e) {
        e?.preventDefault();
        winterModal.classList.add('show');
        winterModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      function closeWinter() {
        winterModal.classList.remove('show');
        winterModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      if (winterOpen) winterOpen.addEventListener('click', openWinter);
      if (winterClose) winterClose.addEventListener('click', closeWinter);
      if (winterModal) winterModal.addEventListener('click', (e) => { if (e.target === winterModal) closeWinter(); });

      // Spring modal
      const springOpen = document.getElementById('openSpring');
      const springModal = document.getElementById('springModal');
      const springClose = document.getElementById('closeSpring');

      function openSpring(e) {
        e?.preventDefault();
        springModal.classList.add('show');
        springModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      function closeSpring() {
        springModal.classList.remove('show');
        springModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      if (springOpen) springOpen.addEventListener('click', openSpring);
      if (springClose) springClose.addEventListener('click', closeSpring);
      if (springModal) springModal.addEventListener('click', (e) => { if (e.target === springModal) closeSpring(); });

      // Summer modal
      const summerOpen = document.getElementById('openSummer');
      const summerModal = document.getElementById('summerModal');
      const summerClose = document.getElementById('closeSummer');

      function openSummer(e) {
        e?.preventDefault();
        summerModal.classList.add('show');
        summerModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      function closeSummer() {
        summerModal.classList.remove('show');
        summerModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      if (summerOpen) summerOpen.addEventListener('click', openSummer);
      if (summerClose) summerClose.addEventListener('click', closeSummer);
      if (summerModal) summerModal.addEventListener('click', (e) => { if (e.target === summerModal) closeSummer(); });

      // Cooking modal
      const cookOpen = document.getElementById('openCooking');
      const cookModal = document.getElementById('cookingModal');
      const cookClose = document.getElementById('closeCooking');

      function openCook(e) {
        e?.preventDefault();
        cookModal.classList.add('show');
        cookModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }
      function closeCook() {
        cookModal.classList.remove('show');
        cookModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      if (cookOpen) cookOpen.addEventListener('click', openCook);
      if (cookClose) cookClose.addEventListener('click', closeCook);
      if (cookModal) cookModal.addEventListener('click', (e) => { if (e.target === cookModal) closeCook(); });

      // ESC closes whichever is open
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (storyModal && storyModal.classList.contains('show')) closeStory();
          if (winterModal && winterModal.classList.contains('show')) closeWinter();
          if (springModal && springModal.classList.contains('show')) closeSpring();
          if (summerModal && summerModal.classList.contains('show')) closeSummer();
          if (cookModal && cookModal.classList.contains('show')) closeCook();
        }
      });
    })();
  </script>
</body>
</html>
